<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <!-- 新 Bootstrap 核心 CSS 文件 -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <!-- 可选的Bootstrap主题文件（一般不用引入） -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="bootstrapvalidator/css/bootstrapValidator.min.css">
  <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
  <script src="js/jquery-3.5.1.min.js"></script>
  <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="bootstrapvalidator/js/bootstrapValidator.min.js"></script>
  <script src="js/jquery-validate.js"></script>
  <link rel="stylesheet" href="css/pad_common.css">
  <script src="js/pad_common.js"></script>
  <script src="js/jquery.jsonrpcclient.js"></script>
  <script src="layer/layer.js"></script>
  <!-- <script src="js/menu.js"></script> -->
  <link rel="stylesheet" href="bootstrap-select/css/bootstrap-select.min.css" />
  <link rel="stylesheet" href="bootstrap-switch/css/bootstrap-switch.min.css" />
  <script type="text/javascript" src="bootstrap-switch/js/bootstrap-switch.min.js"></script>
  <script type="text/javascript" src="bootstrap-select/js/bootstrap-select.min.js"></script>
  <!-- css-->
  <style type="text/css">
    .table-title {
      margin: 36px 0 13px 0;
      text-align: center;
      font-size: 28px;
    }
    .media {
      height: 907px;
      padding: 0 100px 0 100px;
      text-align: center;
      margin: 15px 0 0 0;
    }
    .media .left,.media .right {
      width: 792px;
      /* border: 1px solid #BBB; */
      margin-top: 50px;
      padding: 0;
    }
    .media .left {
      margin-right: 60px;
      width: 862px;
    }
    .media .left .title,.media .right .title {
      height: 70px;
      color: white;
      text-align: center;
      font-size: 22px;
      line-height: 70px;
      background-color: #748288;
      border: 1px solid #748288;
    }
    .media .left .video-content, .media .right .video-content {
      border: 1px solid #BBB;
    }
    .media .left .video-content {
      height: 582px;
    }
    .media .left .video-content .one,
    .media .left .video-content .three,
    .media .left .video-content .four {
      width: 860px;
      height: 580px;
    }
    


    .media .left .video-content .one .input-group {
      width: 859px;
    }
    .media .left .video-content .one .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .left .video-content .one .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .left .video-content .one .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .left .video-content .one .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .left .video-content .one .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .left .video-content .one .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .left .video-content .one .input-group-addon {
      padding: 10px 15px;
    }
    .media .left .video-content .one,
    .media .left .video-content .three,
    .media .left .video-content .four {
      width: 860px;
      /* height: 420px; */
    }
    .media .left .video-content .one .box {
      width: 860px;
      height: 580px;
    }
    .media .left .video-content .three {
      padding: 75px 0;
    }
    .media .left .video-content .three {
      padding: 22px 0;
    }
    .media .left .video-content .three .box {
      width: 288px;
      height: 215px;
    }
    .media .left .video-content .three .box:first-child {
      width: 572px;
      height: 430px;
    }
    .media .left .video-content .three .box {
      width: 250px;
      height: 188px;
    }
    .media .left .video-content .three .box:first-child {
      width: 500px;
      height: 376px;
    }
    .media .left .video-content .three .box .input-group {
      width: 285px;
    }
    .media .left .video-content .three .box:first-child .input-group {
      width: 569px;
    }
    .media .left .video-content .three .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .left .video-content .three .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .left .video-content .three .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .left .video-content .three .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .left .video-content .three .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .left .video-content .three .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .left .video-content .three .input-group-addon {
      padding: 10px 15px;
    }
    .media .left .video-content .four .box {
      width: 430px;
      height: 290px;
    }
    .media .left .video-content .four .box .input-group {
      width: 427px;
    }
    .media .left .video-content .four .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .left .video-content .four .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .left .video-content .four .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .left .video-content .four .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .left .video-content .four .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .left .video-content .four .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .left .video-content .four .input-group-addon {
      padding: 10px 15px;
    }



    .media .right .video-content .single-one .input-group {
      width: 788px;
    }
    .media .right .video-content .single-one .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .right .video-content .single-one .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .right .video-content .single-one .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .right .video-content .single-one .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .right .video-content .single-one .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .right .video-content .single-one .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .right .video-content .single-one .input-group-addon {
      padding: 10px 15px;
    }
    .media .right .video-content .one,
    .media .right .video-content .three,
    .media .right .video-content .four {
      width: 790px;
      /* height: 420px; */
    }
    .media .right .video-content .single-one .box {
      width: 790px;
      height: 520px;
    }
    .media .left .video-content .three .box,
    .media .left .video-content .four .box,
    .media .right .video-content .three .box,
    .media .right .video-content .four .box {
      border: 1px solid #BBB;
      float: left;
    }
    .media .left .video-content .three {
      padding: 75px 0;
    }
    .media .right .video-content .three {
      padding: 22px 0;
    }
    .media .left .video-content .three .box {
      width: 288px;
      height: 215px;
    }
    .media .left .video-content .three .box:first-child {
      width: 572px;
      height: 430px;
    }
    .media .right .video-content .three .box {
      width: 250px;
      height: 188px;
    }
    .media .right .video-content .three .box:first-child {
      width: 500px;
      height: 376px;
    }
    .media .right .video-content .three .box .input-group {
      width: 247px;
    }
    .media .right .video-content .three .box:first-child .input-group {
      width: 497px;
    }
    .media .right .video-content .three .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .right .video-content .three .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .right .video-content .three .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .right .video-content .three .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .right .video-content .three .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .right .video-content .three .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .right .video-content .three .input-group-addon {
      padding: 10px 15px;
    }
    .media .right .video-content .four .box {
      width: 375px;
      height: 210px;
    }
    .media .right .video-content .four .box .input-group {
      width: 372px;
    }
    .media .right .video-content .four .input-group-btn  {
      width: 100%;
      height: 52px;
    }
    .media .right .video-content .four .input-group-btn .btn-group {
      width: 100%;
      height: 52px;
      font-size: 20px;
    }
    .media .right .video-content .four .input-group-btn .btn-group * {
      font-size: 20px;
      color: black;
      text-shadow: none;
    }
    .media .right .video-content .four .input-group-btn .btn-group .filter-option {
      height: 40px;
      line-height: 40px;
    }
    .media .right .video-content .four .input-group .input-group-addon {
      top: 1px;
      position: inherit;
    }
    .media .right .video-content .four .input-group .input-group-addon.active {
      background-color: #5cb85c;
    }
    .media .right .video-content .four .input-group-addon {
      padding: 10px 15px;
    }
    .media .left .button-group {
      margin-top: 20px;
      /* padding: 0 33px; */
    }
    .media .left .button-group .button {
      width: 156px;
      float: left;
      margin-right: 20px;
    }
    .media .left .button-group .button:last-child {
      margin-right: 0;
    }
    .media .left .button-group .button .name {
      margin-top: 5px;
      font-size: 22px;
    }
    .media .left .auto-answer-group {
      margin-top: 160px;
      font-size: 22px;
    }

    .camera-control {
      background: url(images/109.png) center no-repeat;
      background-size: 30% 50%;
    }

    .pad {
      /* border: 1px solid red;
      position: absolute;
      top: 10px;
      width: 100%;
      z-index: 100;
      background-color: rgba(0, 0, 0, 0.4); */
    }
    .pad .pad-group {
      /* margin: 40px 0 0 293px; */
      border: 1px solid gray;
      border-radius: 20px;
      /* width: 290px; */
      padding: 20px;
    }
    .pad .pad-group .pads {
      width: 256px;
      height: 256px;
      margin: auto;
      background-image: url('images/1091.png');
    }
    .pad .pad-group .pads .arrow {
      /* border: 1px solid red; */
      width: 100px;
      height: 100px;
      position: relative;
    }
    .pad .pad-group .pads .left {
      top: -22px;
    }
    .pad .pad-group .pads .right {
      float: right;
      top: -122px;
    }
    .pad .pad-group .pads .up,
    .pad .pad-group .pads .down {
      left: 78px;
    }
    .pad .pad-group .pads .down {
      top: -44px;    
    }
    .pad .pad-group .zoom-group img {
      margin-top: 10px;
      width: 96px;
      height: 96px;
    }
    .pad .pad-group .zoom-group img:first-child {
      /* float: right; */
      position: relative;
      left: 107px;
    }
    .pad .pad-group .zoom-group img:last-child {
      /* float: right; */
      position: relative;
      left: 223px;
    }
    .modal-dialog {
      margin: 220px auto;
    }
  </style>
</head>
  
<body class="whole_body">
  <!-- 内容 -->
  <div class="app container-fluid">
    <!-- 顶部 -->
    <div class="row top">
      <div class="col-md-3 title">数字化手术室</div>
      <div class="col-md-6 text-center">
        <div id="timeNow" class="time">2020年4月28日12时12分&nbsp;&nbsp;星期三</div>
      </div>
      <div class="col-md-3">
        <img class="logo" src="images/logo.png" />
      </div>
    </div>

    <!-- title -->
    <div class="row table-title">【】 - 手术室连线中</div>

    <!-- table -->
    <div class="row media">
      <div class="col-md-6 left">
        <div class="title">主屏输出（4K）</div>
        <div class="video-content">
          <div class="one">
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
          </div>
          <div class="three" hidden>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
          </div>
          <div class="four" hidden>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <span class="input-group-addon"><img src="images/voice.png" /></span>
              </div><!-- /input-group -->
            </div>
          </div>
        </div>
        <div class="button-group">
          <div class="button">
            <img src="images/401.png" />
            <div class="name">单画面</div>
          </div>
          <div class="button">
            <img src="images/402.png" />
            <div class="name">三画面</div>
          </div>
          <div class="button">
            <img src="images/403.png" />
            <div class="name">四画面</div>
          </div>
          <div class="button btn-push-stream">
            <img src="images/404.png" />
            <div class="name">开始推流</div>
          </div>
          <div class="button">
            <img src="images/406.png" />
            <div id="meetingRoleName" class="name">关闭连接</div>
          </div>
        </div>
      </div>
      <div class="col-md-5 right">
        <div class="title">副屏输出（1080P）</div>
        <div class="video-content">
          <div class="single-one">
            <div class="box">
              <div class="input-group">
                <div class="input-group-btn">
                  <select class="selectpicker" title="请选择视频源...">
                    <option value='-1'>空</option>

                  </select>
                </div>
                <!-- <span class="input-group-addon"><img src="images/voice.png" /></span> -->
              </div><!-- /input-group -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="pad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">云台控制</h4>
          </div>
          <div class="modal-body">
            <div class="pad">
              <div class="pad-group">
                <div class="pads">
                    <div title="up" onclick="upControl();" class="arrow up"></div>
                    <div title="left" onclick="leftControl();" class="arrow left"></div>
                    <div title="right" onclick="rightControl();" class="arrow right"></div>
                    <div title="down" onclick="downControl();" class="arrow down"></div>
                </div>
                <div class="zoom-group">
                    <img title="zoom-in" onclick="zoomInControl();" src="images/1092.png" />
                    <img title="zoom-out" onclick="zoomOutControl();" src="images/1093.png" />
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript">
let operatingRoomChannelList = [];
let screenCount = 0;
let currentRoomDecoder = null;
let linkpiConfig = null;
let linkpiMix = null;
let srcV = [];
let srcA = [];
// 副屏视频源
let additionaScreenlSrc = null;
// 是否推流标志位
let pushStreamState = false; 
/**
 * 灵派画面布局参数
 * 0-单画面 1-四分格 2-九宫格 3-1+2 4-画中画
 */
let linkpiLayout = [
  [{ a: 1, x: 0, y: 0, w: 1, h: 1, index: 0 }],
  [
    { a: 1, x: 0, y: 0, w: 1 / 2, h: 1 / 2, index: 0 },
    { a: 1, x: 1 / 2, y: 0, w: 1 / 2, h: 1 / 2, index: 1 },
    { a: 1, x: 0, y: 1 / 2, w: 1 / 2, h: 1 / 2, index: 2 },
    { a: 1, x: 1 / 2, y: 1 / 2, w: 1 / 2, h: 1 / 2, index: 3 }
  ],
  [
    { a: 1, x: 0, y: 0, w: 1 / 3, h: 1 / 3, index: 0 },
    { a: 1, x: 1 / 3, y: 0, w: 1 / 3, h: 1 / 3, index: 1 },
    { a: 1, x: 2 / 3, y: 0, w: 1 / 3, h: 1 / 3, index: 2 },
    { a: 1, x: 0, y: 1 / 3, w: 1 / 3, h: 1 / 3, index: 3 },
    { a: 1, x: 1 / 3, y: 1 / 3, w: 1 / 3, h: 1 / 3, index: 4 },
    { a: 1, x: 2 / 3, y: 1 / 3, w: 1 / 3, h: 1 / 3, index: 5 },
    { a: 1, x: 0, y: 2 / 3, w: 1 / 3, h: 1 / 3, index: 6 },
    { a: 1, x: 1 / 3, y: 2 / 3, w: 1 / 3, h: 1 / 3, index: 7 },
    { a: 1, x: 2 / 3, y: 2 / 3, w: 1 / 3, h: 1 / 3, index: 8 }
  ],
  [
    { a: 1, x: 0, y: 1 / 6, w: 2 / 3, h: 2 / 3, index: 0 },
    { a: 1, x: 2 / 3, y: 1 / 6, w: 1 / 3, h: 1 / 3, index: 1 },
    { a: 1, x: 2 / 3, y: 3 / 6, w: 1 / 3, h: 1 / 3, index: 2 }
  ],
  [
    { a: 1, x: 0, y: 0, w: 1, h: 1, index: 0 },
    { a: 1, x: 2 / 3, y: 2 / 3, w: 1 / 4, h: 1 / 4, index: 1 }
  ]
];
let shxitConfigParams = [
    {
      "WindowIndex": 0,
      "AccessSourceID": 32768,
      "CachingTime": -1,
      "BuildInSource": {
        "Address": "rtsp://192.168.1.229:554/ch1_main"
      }
    },
    {
      "WindowIndex": 1,
      "AccessSourceID": 98304,
      "CachingTime": -1,
      "BuildInSource": {
        "Address": "rtsp://192.168.1.229:554/ch1_main"
      }
    },
    {
      "WindowIndex": 2,
      "AccessSourceID": 163840,
      "CachingTime": -1,
      "BuildInSource": {
        "Address": "rtsp://192.168.1.229:554/ch1_main"
      }
    },
    {
      "WindowIndex": 3,
      "AccessSourceID": -1,
      "CachingTime": -1,
      "BuildInSource": {
        "Address": "rtsp://192.168.1.229:554/ch1_main"
      }
    },
    {
      "WindowIndex": 4,
      "AccessSourceID": -1,
      "CachingTime": -1,
      "BuildInSource": {
        "Address": ""
      }
    }
  ];

let shxitLayout = {1: "Mode1", 2: "Mode3_1", 3: "Mode3_1", 4: "Mode4"};
// 通道数量与分屏数量映射关系。
let screenCountLayoutCount = [1, 1, 3, 3, 4, 4, 4, 4];

//灵派编码器内容处理
function dealLinkPi() {
  linkpiChannelIdUrlMapping = {};
  linkpiUrlChannelIdMapping = {};
  for (let i = 0; i < linkpiConfig.length; i++) {
    // 不知道咋回事，有毒，修复hls文件名格式为：-%06d.ts
    linkpiConfig[i].hls.hls_filename = "-%06d.ts";
    if('net' === linkpiConfig[i].type) {
      linkpiChannelIdUrlMapping[channelUrlIdMapping[linkpiConfig[i].net.path]] = linkpiConfig[i].id;
      linkpiUrlChannelIdMapping[linkpiConfig[i].id + ""] = channelUrlIdMapping[linkpiConfig[i].net.path];
      console.log(linkpiConfig[i].id + " " + channelUrlIdMapping[linkpiConfig[i].net.path] + " " + linkpiConfig[i].net.path);
    }
    if('mix' === linkpiConfig[i].type) {
      linkpiMix = linkpiConfig[i];
      break;
    }
  }
  //获取mix通道信息
  pushStreamState = linkpiMix.stream.push.enable; // 初始化推流标志位
  if (pushStreamState) {
    let btnPushStream = $('.btn-push-stream');
    btnPushStream.children('img').prop('src', 'images/405.png');
    btnPushStream.children('.name').text('结束推流');
  }
  console.log(linkpiMix.layout);
  let layout = linkpiMix.layout;
  srcV = linkpiMix.srcV;//视频通道参数
  console.log(srcV);
  srcA = linkpiMix.srcA;//音频通道参数
  console.log(srcA);
  let index = getArrayIndex(linkpiLayout, layout);
  console.log(index);
  screenCount = linkpiLayout[index].length;
  additionaScreenlSrc = linkpiMix.output2.src;
  console.log(additionaScreenlSrc);
  // 修改主屏显示
  changeScreen(screenCount);
  // 修改副屏显示
  changeAdditionalScreen();
}
function getArrayIndex(arr, obj) {
  let i = arr.length;
  while (i--) {
    if (arr[i].length == obj.length) {
      return i;
    }
  }
  return -1;
}
// 提交分屏数据
function commitSreenSet() {
  // 灵派解码器修改窗口布局。
  if (null != currentRoomDecoder && DECODER_LINKPI === currentRoomDecoder.manufacturer) {
    let currentLinkpiLayout = null;
    // 遍历并匹配当前设置的布局参数
    linkpiLayout.forEach((e, i) => {
      if(e.length === screenCount) {
        currentLinkpiLayout = linkpiLayout[i];
      }
    });
    let newinfo;
    linkpiConfig.forEach(function (n, i) {
      if (n.type == "mix") {
        newinfo = n;
        // 修改主屏Mix混合输出信息
        newinfo.srcV = srcV.slice(0, screenCount);
        console.log(newinfo.srcV);
        newinfo.srcA = srcA.slice(0, screenCount);
        srcA = newinfo.srcA;
        newinfo.layout = currentLinkpiLayout;

        // 修改推流标志位
        newinfo.stream.push.enable = pushStreamState;
        newinfo.stream2.push.enable = pushStreamState;
        // 修改副屏输出信息
        console.log(typeof additionaScreenlSrc);
        newinfo.output2.src = additionaScreenlSrc;

        linkpiConfig[i] = newinfo;
      }
    })
    
    try {
      let rpcParams = {jsonrpc:"2.0", method:"enc.update", params:[JSON.stringify(linkpiConfig)],id:1};
      // 提交分屏设置至编码器
      AOV.commitEncoderConfig(currentRoomDecoder.ip, currentRoomDecoder.manufacturer, JSON.stringify(rpcParams));
    } catch(e) { console.error(e); }
  }
  // 示见解码器修改窗口布局。
  if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
    let screenLayoutName = shxitLayout[screenCount];
    try {
      // 提交分屏设置至示见编码器
      AOV.commitShxitDeviceScreenLayout(currentRoomDecoder.ip, currentRoomDecoder.manufacturer, screenLayoutName, "");
    } catch(e) { console.error(e); }
  }
}
let connectedOperatingRoom = null;
let currentRoom = null;
let currentRoomEncoder = null;
let currentRoomDecoderChannelSize = 0;           // 当前房间解码通道数量。
let currentRoomConnectedEncoderConfig = null;
let currentChannelSerialPort = null;
let channelIdUrlMapping = null;
let channelUrlIdMapping = null;
let linkpiChannelIdUrlMapping = null;
let linkpiUrlChannelIdMapping = null;
$(document).ready(function() {
  try {
    // $('#pad').modal({
    //   show: true
    // });
    // 获取当前房间信息
    currentRoom = JSON.parse(AOV.getCurrentRoom());
    if(0 < currentRoom.decoderDevices.length) {
      currentRoomDecoder = currentRoom.decoderDevices[0];
      currentRoom.decoderDevices.forEach(device => {
        currentRoomDecoderChannelSize += device.channelCount;
      });
      // 示解码器没有副屏，禁用。
      if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
        // console.log("disable single-one select!");
        // 示见解码器，禁用副屏输出。
        $('.single-one select').attr("disabled", "disabled");
      }
      // 解码器获取配置信息
      if (null != currentRoomDecoder) {
        try {
          AOV.getDeviceConfig(currentRoomDecoder.ip, currentRoomDecoder.manufacturer);
        } catch(e) { console.error(e); }
      }
    }
    
    // console.log(currentRoom.decoderDevices.length);
    // 获取当前房间连线中的手术室信息
    connectedOperatingRoom = JSON.parse(AOV.getConnectedOperatingRoom());
    // 获取当前房间连线中的手术室通道信息
    operatingRoomChannelList = connectedOperatingRoom.channels;
    // console.log(operatingRoomChannelList);
    $('.table-title').text('【'+connectedOperatingRoom.name+'】 - 手术室连线中');
    
    // 获取当前房间连线中的手术室编码器配置信息
    // currentRoomConnectedEncoderConfig = AOV.getCurrentRoomConnectedEncoderConfig();
    // linkpiConfig = JSON.parse(currentRoomConnectedEncoderConfig);
    // 绑定通道列表
    refreshOperatingChannels();
    // 绑定分屏信息
    screenCount = screenCountLayoutCount[operatingRoomChannelList.length];
  } catch (e) { console.error(e); }

  // $("#meetingRoleName").text(1 === meetingRole ? "结束会议": "退出观看");
  // 切换Mix通道视频布局
  $('.button').click(function() {
    const btnName = $(this).children('.name').text();
    // console.log(btnName);
    if('单画面' === btnName) {
      screenCount = 1;
      changeScreen(screenCount);
      commitSreenSet();
    } else if('三画面' === btnName) {
      screenCount = 3;
      changeScreen(screenCount);
      commitSreenSet();
    } else if('四画面' === btnName) {
      screenCount = 4;
      changeScreen(screenCount);
      commitSreenSet();
    } else if('开始推流' === btnName) {
      console.log('开始推流按钮被点击！');
      startPushStream($(this));
    } else if('结束推流' === btnName) {
      console.log('结束推流按钮被点击！');
      stopPushStream($(this));
    } else {
      ringOff();
    }
  });
  $(".video-content select").change(function() {
    let _i = 0;
    let _this_select = $(this);
    let boxElement = $(this).parents('.box');//.index(this);
    let _selected_id = _this_select.val();
    // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
    dealEvent(boxElement, _selected_id);
    
    // $(this).siblings().each(function(i, element) {
    //   console.log(element, element === _this_select);
    // });
    let boxElements = boxElement.parent().children();
    // 获取当前修改的源位于窗口的位置
    _i = boxElements.index(boxElement);
    // console.log("screen count: " + boxElements.length);
    // console.log(_i)
    
    // console.log(srcV);
    if (null != currentRoomDecoder && DECODER_LINKPI === currentRoomDecoder.manufacturer) {
      if(0 < $(this).parents('.right').length) { // 提交VGA输出
        additionaScreenlSrc = linkpiChannelIdUrlMapping[_selected_id] + "";
      } else { // 提交HDMI的Mix通道输出
        srcV[_i] = linkpiChannelIdUrlMapping[_selected_id] + "";
      }
      commitSreenSet();
    }
    if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
      shxitConfigParams[_i].AccessSourceID = -1;
      shxitConfigParams[_i].BuildInSource.Address = channelIdUrlMapping[_selected_id];
      // console.log(_selected_id + " " + channelIdUrlMapping[_selected_id]);
      // console.log(_i);
      // console.log(shxitConfigParams[_i].BuildInSource.Address);
      try {
        // 提交拉流配置至示见编解码器
        AOV.commitShxitDeviceConfig(currentRoomDecoder.ip, currentRoomDecoder.manufacturer, JSON.stringify(shxitConfigParams));
      } catch(e) { console.error(e); }
    }
  });
  $(".box .input-group-addon").click(function(event) {
    event.stopPropagation(); // 阻止事件冒泡，避免传递到空白区域，造成重复点击而显示弹窗。
    // console.log("音频按钮被点击");
    let _this_voice_span = $(this);
    let _this_select = _this_voice_span.parent().find('select');
    let _current_channel = _this_select.val();
    let boxElement = _this_voice_span.parents('.box');
    let boxElements = boxElement.parent().children();
    
    // console.log(_current_channel);
    if ("" === _current_channel || -1 === _current_channel) {
      // invalid channel
      return;
    }
    // console.log(linkpiChannelIdUrlMapping[_current_channel]);
    // 获取当前修改的源位于窗口的位置
    let srcAIndex = boxElements.index(boxElement);
    if(_this_voice_span.hasClass("active")) {
      _this_voice_span.removeClass("active")
      srcA[srcAIndex] = "";
    } else {
      _this_voice_span.addClass("active")
      srcA[srcAIndex] = linkpiChannelIdUrlMapping[_current_channel] + "";
    }
    commitSreenSet();
  });

  $('#pad').on('show.bs.modal', function(e) {
    console.log("对话框即将显示，切换串口: " + currentChannel.serialPort);
  // })
  // .on('shown.bs.modal', function (e) {
    try {
      currentChannelSerialPort = JSON.parse(currentChannel.serialPort);
      AOV.changeRemoteSerialPort(currentChannel.serialPort);
    } catch (e) { console.error(e); }
    // 监控方向按钮点击事件
    // $('.pads>.arrow').click(function () {
    //   let arrowTitle = $(this).attr('title');
    //   console.log(arrowTitle);
    //   if ('up' === arrowTitle) { // 上
        
    //   } else if ('left' === arrowTitle) { // 左
        
    //   } else if ('right' === arrowTitle) { // 右
        
    //   } else if ('down' === arrowTitle) { // 下
        
    //   }
    // });
    // 监控放大缩小按钮点击事件
    // $('.zoom-group>img').click(function() {
    //   let btnTitle = $(this).attr('title');
    //   console.log(btnTitle);
    //   if ('zoom-in' === btnTitle) { // 放大
        
    //   } else if ('zoom-out' === btnTitle) { // 缩小
        
    //   }
    // });
  })
});
function upControl() {
  console.log("up");
  try { // 调用安卓发送串口指令 上
    // 十进制校验码计算
    let checkcode = 134 + currentChannelSerialPort.addr;
    let upCommandStr = 'FF0'+currentChannelSerialPort.addr+'00083F3F' + checkcode.toString(16);
    AOV.sendRemoteCommand(upCommandStr);
    autoStopControl(upCommandStr);
  } catch (e) { console.error(e); }
}
function downControl() {
  console.log("down");
  try { // 调用安卓发送串口指令 下
    // 十进制校验码计算
    let checkcode = 142 + currentChannelSerialPort.addr;
    let downCommandStr = 'FF0'+currentChannelSerialPort.addr+'00103F3F' + checkcode.toString(16);
    AOV.sendRemoteCommand(downCommandStr);
    autoStopControl(downCommandStr);
  } catch (e) { console.error(e); }
}
function leftControl() {
  console.log("left");
  try { // 调用安卓发送串口指令 左
    // 十进制校验码计算
    let checkcode = 130 + currentChannelSerialPort.addr;
    let leftCommandStr = 'FF0'+currentChannelSerialPort.addr+'00043F3F' + checkcode.toString(16);
    AOV.sendRemoteCommand(leftCommandStr);
    autoStopControl(leftCommandStr);
  } catch (e) { console.error(e); }
}
function rightControl() {
  console.log("right");
  try { // 调用安卓发送串口指令 右
    // 十进制校验码计算
    let checkcode = 128 + currentChannelSerialPort.addr;
    let rightCommandStr = 'FF0'+currentChannelSerialPort.addr+'00023F3F' + checkcode.toString(16);
    AOV.sendRemoteCommand(rightCommandStr);
    autoStopControl(rightCommandStr);
  } catch (e) { console.error(e); }
}
function zoomInControl() {
  console.log("zoom-in");
  try { // 调用安卓发送串口指令 缩小
    // 十进制校验码计算
    let checkcode = 32 + currentChannelSerialPort.addr;
    let zoomInCommandStr = 'FF0'+currentChannelSerialPort.addr+'00200000' + checkcode.toString(16);
    AOV.sendRemoteCommand(zoomInCommandStr);
    autoStopControl(zoomInCommandStr);
  } catch (e) { console.error(e); }
}
function zoomOutControl() {
  console.log("zoom-out");
  try { // 调用安卓发送串口指令 缩小
    // 十进制校验码计算
    let checkcode = 64 + currentChannelSerialPort.addr;
    let zoomOutCommandStr = 'FF0'+currentChannelSerialPort.addr+'00400000' + checkcode.toString(16);
    AOV.sendRemoteCommand(zoomOutCommandStr);
    autoStopControl(zoomOutCommandStr);
  } catch(e) { console.error(e); }
}

// 延时自动停止控制
let currentControlObj = null;
let currentControlObjTimeout = null;
function autoStopControl(obj) {
  if(obj === currentControlObj) { // 如果当前控制对象没有发生改变, 则先清除该对象的定时器, 再重设定时器.
    clearTimeout(currentControlObjTimeout);
  } else { // 当前控制对象不是之前的, 则不清空原定时器. 修改当前控制对象赋值.
    currentControlObj = obj;
  }
  currentControlObjTimeout = setTimeout(function () {
    AOV.sendRemoteCommand('FF0'+currentChannelSerialPort.addr+'000000000'+currentChannelSerialPort.addr);
  }, 200);
}
// 为绑定了摄像机的通道绑定点击事件，点击后弹出云台控制面板
function dealEvent(ele, id) {
  // console.log(id);
  // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
  let currentChannel = getChannel(id);
  // console.log(currentChannel);
  if(null != currentChannel && currentChannel.serialPort) { 
    // console.log("null != currentChannel && currentChannel.serialPort");
    // 当前通道绑定了摄像机，因此可以使用云台控制功能，需要绑定点击事件。
    ele.addClass('camera-control');
    ele.bind('click', {channelInfo: currentChannel}, showPad);
  } else {
    // 当前通道未绑定摄像机，需要解绑点击事件。
    ele.removeClass('camera-control');
    ele.unbind('click');
  }
}

let currentChannel = null;
function showPad(e) {
  console.log(e.data.channelInfo.name + " " + e.target.className);
  if('box camera-control' === e.target.className) {
    console.log('box clicked!');
    // 被点击，弹出云台控制模态窗口
    currentChannel = e.data.channelInfo;
    $('#pad').modal({
      show: true
    });
  } else {
    currentChannel = null;
  }
}

/**
 * 遍历通道列表，根据通道名称获取通道信息。
 */
function getChannel(channelId) {
  for(var i = 0; i < operatingRoomChannelList.length; i++) {
    if(channelId == operatingRoomChannelList[i].id) {
      return operatingRoomChannelList[i];
    }
  }
  return null;
}

// 刷新手术室通道列表
function refreshOperatingChannels() {
  let tmpSelectPicker = $(".video-content select");
  let netIndex = 0;
  channelIdUrlMapping = {};
  channelUrlIdMapping = {};
  operatingRoomChannelList.forEach((e, i) => {
    if(netIndex >= currentRoomDecoderChannelSize) {
      return;
    }
    console.log(e.id + " " + operatingRoomChannelList[netIndex].name + " " + operatingRoomChannelList[netIndex].channelId);
    tmpSelectPicker.append(
      '<option value="'+e.id+'">'+connectedOperatingRoom.name + " - " + operatingRoomChannelList[netIndex].name+'</option>'
    );
    channelIdUrlMapping[e.id+""] = e.url;
    channelUrlIdMapping[e.url] = e.id;
    netIndex ++;
  });
  tmpSelectPicker.selectpicker('refresh');
}
// 保存定时更新画面截图的定时器句柄
let srcVPreviewInterval = [null, null, null, null];
function previewChannel(box, i) {
  // 添加定时器
  srcVPreviewInterval[i] = setInterval(function () {
    setPreview(box, srcV[i]);
  }, 50000);
}
function setPreview(box, channelId) {
  // let previewUrl = 'http://' + encoderIp + (encoderPort === 80 ? '' : ':' + encoderPort) + '/snap/snap' + channelId + '.jpg?rnd=' + Math.random();
  // // console.log(previewUrl);
  // box.css('background', 'url(' + previewUrl + ') no-repeat')
  //     .css('background-size', '100% 100%');
}
function changeScreen(count) {
  let oneElement = $('.one');
  let threeElement = $('.three');
  let fourElement = $('.four');
  // 预览地址规则：http://IP[:PORT]/snap/snap[通道号].jpg?rnd=随机值
  switch(count) {
    case 1:
      oneElement.removeAttr('hidden');
      threeElement.attr('hidden', 'hidden');
      fourElement.attr('hidden', 'hidden');
      oneElement.find('select').each((i, e) => {
        let _this_select = $(e);
        if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
          // 示见编码器，仅允许修改窗口布局，不允许修改每个窗口的流。
          if(i < operatingRoomChannelList.length) {
            let _selected_id = channelUrlIdMapping[shxitConfigParams[i].BuildInSource.Address];
            _this_select.val(_selected_id);
            let boxElement = _this_select.parents('.box');//.index(this);
            // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
            dealEvent(boxElement, _selected_id);
          }
          // _this_select.attr("disabled", "disabled");
          _this_select.selectpicker('refresh');
          _this_select.parents('.input-group-btn').siblings('.input-group-addon').hide();
          console.log(shxitLayout[count]);
        }
        // 灵派编码器，绑定布局
        if (null != currentRoomDecoder && DECODER_LINKPI === currentRoomDecoder.manufacturer) {
          let _selected_id = linkpiUrlChannelIdMapping[srcV[i] + ""];
          _this_select.val(_selected_id);
          // bootstrap-select 必须调用一次刷新才会更新选中状态
          _this_select.selectpicker('refresh');
          let parentBox = _this_select.parents('.box');
          // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
          dealEvent(parentBox, _selected_id);
          // 设置音频激活状态
          let voiceSpan = _this_select.parents('.input-group-btn').siblings('.input-group-addon');
          srcA.forEach((v, j) => {
            if (undefined !== srcV[i] && null !== srcV[i] && null !== v && "" !== v && v == srcV[i]) { // 当前视频通道对应的音频存在，则设置为激活状态
              voiceSpan.addClass('active');
            // } else {
            //   voiceSpan.removeClass('active');
            }
          });
          // if (null !== srcVPreviewInterval[i]) { // 清除原定时器
          //   clearInterval(srcVPreviewInterval[i]);
          //   srcVPreviewInterval[i] = null;
          // }
          // // 预览通道截图
          // setPreview(parentBox, srcV[i]);
          // previewChannel(parentBox, i);
        }
      });
      // 清空其它定时器
      // srcVPreviewInterval.forEach((e, i) => {
      //   if (0 < i && null !== e) {
      //     clearInterval(e);
      //     srcVPreviewInterval[i] = null;
      //   }
      // });
      break;
    case 3:
      oneElement.attr('hidden', 'hidden');
      threeElement.removeAttr('hidden');
      fourElement.attr('hidden', 'hidden');
      threeElement.find('select').each((i, e) => {
        let _this_select = $(e);
        if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
          // 示见编码器，仅允许修改窗口布局，不允许修改每个窗口的流。
          if(i < operatingRoomChannelList.length) {
            let _selected_id = channelUrlIdMapping[shxitConfigParams[i].BuildInSource.Address];
            _this_select.val(_selected_id);
            let boxElement = _this_select.parents('.box');//.index(this);
            // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
            dealEvent(boxElement, _selected_id);
          }
          // _this_select.attr("disabled", "disabled");
          _this_select.selectpicker('refresh');
          _this_select.parents('.input-group-btn').siblings('.input-group-addon').hide();
          console.log(shxitLayout[count]);
        }
        // 灵派编码器，绑定布局
        if (null != currentRoomDecoder && DECODER_LINKPI === currentRoomDecoder.manufacturer) {
          let _selected_id = linkpiUrlChannelIdMapping[srcV[i] + ""];
          _this_select.val(_selected_id);
          // bootstrap-select 必须调用一次刷新才会更新选中状态
          _this_select.selectpicker('refresh');
          let parentBox = _this_select.parents('.box');
          // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
          dealEvent(parentBox, _selected_id);
          // 设置音频激活状态
          let voiceSpan = _this_select.parents('.input-group-btn').siblings('.input-group-addon');
          srcA.forEach((v, j) => {
            if (undefined !== srcV[i] && null !== srcV[i] && null !== v && "" !== v && v == srcV[i]) { // 当前视频通道对应的音频存在，则设置为激活状态
              voiceSpan.addClass('active');
            // } else {
            //   voiceSpan.removeClass('active');
            }
          });
          // if (null !== srcVPreviewInterval[i]) { // 清除原定时器
          //   clearInterval(srcVPreviewInterval[i]);
          //   srcVPreviewInterval[i] = null;
          // }
          // setPreview(parentBox, srcV[i]);
          // previewChannel(parentBox, i);
        }
      });
      // if (null !== srcVPreviewInterval[3]) { // 清空第四画面定时器
      //   clearInterval(srcVPreviewInterval[3]);
      //   srcVPreviewInterval[3] = null;
      // }
      break
    case 4:
      oneElement.attr('hidden', 'hidden');
      threeElement.attr('hidden', 'hidden');
      fourElement.removeAttr('hidden');
      fourElement.find('select').each((i, e) => {
        let _this_select = $(e);
        if (null != currentRoomDecoder && DECODER_SHXIT === currentRoomDecoder.manufacturer) {
          // 示见编码器，仅允许修改窗口布局，不允许修改每个窗口的流。
          if(i < operatingRoomChannelList.length) {
            let _selected_id = channelUrlIdMapping[shxitConfigParams[i].BuildInSource.Address];
            _this_select.val(_selected_id);
            let boxElement = _this_select.parents('.box');//.index(this);
            // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
            dealEvent(boxElement, _selected_id);
          }
          // _this_select.attr("disabled", "disabled");
          _this_select.selectpicker('refresh');
          _this_select.parents('.input-group-btn').siblings('.input-group-addon').hide();
          console.log(shxitLayout[count]);
        }
        // 灵派编码器，绑定布局
        if (null != currentRoomDecoder && DECODER_LINKPI === currentRoomDecoder.manufacturer) {
          let _selected_id = linkpiUrlChannelIdMapping[srcV[i] + ""];
          _this_select.val(_selected_id);
          // bootstrap-select 必须调用一次刷新才会更新选中状态
          _this_select.selectpicker('refresh');
          // 设置音频激活状态
          let voiceSpan = _this_select.parents('.input-group-btn').siblings('.input-group-addon');
          srcA.forEach((v, j) => {
            if (undefined !== srcV[i] && null !== srcV[i] && null !== v && "" !== v && v == srcV[i]) { // 当前视频通道对应的音频存在，则设置为激活状态
              voiceSpan.addClass('active');
            // } else {
            //   voiceSpan.removeClass('active');
            }
          });
          let parentBox = _this_select.parents('.box');
          // 判断当前选中的通道，是否绑定摄像机，绑定了的话，则给父元素.box绑定点击事件，点击后弹出云台控制窗口。
          dealEvent(parentBox, _selected_id);
        }

        // if (null !== srcVPreviewInterval[i]) { // 清除原定时器
        //   clearInterval(srcVPreviewInterval[i]);
        //   srcVPreviewInterval[i] = null;
        // }
        // setPreview(parentBox, srcV[i]);
        // previewChannel(parentBox, i);
      });
      break;
    default: break;
  }
}
// 挂断
function ringOff(){
  try {
    //通知手术室会议结束，其余也被迫退出
    AOV.ringOff();
  } catch(e) { console.error(e); }
  autoExit(); // 退出会议，回到进入会议前的页面。
}
// 会议中止自动退出，隐藏播放窗口，回到进入会议前的页面
function autoExit() {
  try {
    // 隐藏播放窗口
    window.AOV.hidenPlayView();
  } catch(e) { console.error(e); }
  window.history.go(-1); // 退出后回到进入会议前的页面
}
// 由安卓调用，退出会议。
function closeScreenView() {
  autoExit();
}
/**
 * 修改副屏显示
 */
function changeAdditionalScreen() {
  let additionalScreenSelect = $('.single-one select');
  additionalScreenSelect.val(linkpiUrlChannelIdMapping[additionaScreenlSrc + ""]);
  additionalScreenSelect.selectpicker('refresh');
}
//开始推流
function startPushStream(btn) {
  pushStreamState = true;
  commitSreenSet();
  // 修改推流按钮状态与图标
  btn.children('img').prop('src', 'images/405.png');
  btn.children('.name').text('结束推流');
}
//停止推流
function stopPushStream(btn) {
  pushStreamState = false;
  commitSreenSet();
  // 修改推流按钮状态与图标
  btn.children('img').prop('src', 'images/404.png');
  btn.children('.name').text('开始推流');
}
// 解码器配置加载完成
function onDeviceConfigLoaded(deviceType, config) {
  console.log(deviceType);
  console.log(config);
  if(DECODER_LINKPI === deviceType) {
    linkpiConfig = config;
    // console.log(currentRoomConnectedEncoderConfig);
    // linkpiConfig = JSON.parse(currentRoomConnectedEncoderConfig);
    dealLinkPi();
  }
  if(DECODER_SHXIT === deviceType) {
    shxitConfigParams = config.AllAccess;
    changeScreen(screenCount);
    commitSreenSet();
  }
}
</script>
</html>