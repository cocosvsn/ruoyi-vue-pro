<!DOCTYPE html>
<html lang="en">
<head>
  <title>首视</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <!-- 新 Bootstrap 核心 CSS 文件 -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <!-- 可选的Bootstrap主题文件（一般不用引入） -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="bootstrapvalidator/css/bootstrapValidator.min.css">
  <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
  <script src="js/jquery-3.5.1.min.js"></script>
  <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="bootstrapvalidator/js/bootstrapValidator.min.js"></script>
  <script src="js/jquery-validate.js"></script>
  <link rel="stylesheet" href="css/pad_common.css">
  <script src="js/pad_common.js"></script>
  <script src="js/jquery.jsonrpcclient.js"></script>
  <script src="layer/layer.js"></script>
  <script src="js/menu.js"></script>
  <!-- css-->
  <style type="text/css">
    .page {
      position: fixed;
      left: 0;
      top: 0;
    }
    .camera {
      width: 100%;
      box-sizing: border-box;
      margin: 30px 0 0 0;
      padding-left: 56px;
    }
    .camera .item {
      width: 184px;
      margin-right: 48px;
      text-align: center;
      padding: 0;
    }
    .camera .item .title {
      line-height: 30px;
      font-size: 21px;
      font-weight: 800;
    }
    .camera .item .icon {
      border: 2px solid gray;
      width: 184px;
      height: 184px;
      border-radius: 10px;
    }
    .camera .active .icon {
      border: 2px solid #5cb85c;
    }
    .camera .item .check {
      margin-top: 6px;
    }
    .control {
      width: 100%;
      height: 598px;
      margin-top: 30px;
      margin-left: 0;
      margin-right: 0;
      padding: 0 56px;
    }
    .control .left {
      padding: 0;
      width: 960px;
      height: 540px;
    }
    #videoView {
      border: 1px solid gray;
    }
    /**
     * Checkbox 样式
     */
    .checkbox-custom {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #01ABED;
      border-radius: 40px;
    }
    /**
     * 将初始的checkbox的样式改变
     */
    .checkbox-custom input[type="checkbox"] {
      width: 40px;
      height: 40px;
      opacity: 0;/*将初始的checkbox隐藏起来*/
      position: absolute;
      cursor: pointer;
      z-index: 2;
      margin: -6px 0 0 0;
      top: 3px;
      left: -3px;
      border: none;
    }
    /**
     * 设计新的checkbox，位置
     */
    .checkbox-custom label:before {
      content: '';
      margin-top: 5px;
      width: 24px;
      height: 24px;
      display: inline-block;
      border-radius: 25px;
      border: 1px solid #bbb;
      background: #fff;
    }
    /**
     * 点击初始的checkbox，将新的checkbox关联起来
     */
    .checkbox-custom input[type="checkbox"]:checked +label:after {
      position: absolute;
      display: inline-block;
      font-family: 'Glyphicons Halflings';
      content: "\e013";
      top: 8px;
      left: 8px;
      width: 18px;
      height: 18px;
      line-height: 1;
      color: #01ABED;
      background-color: #01ABED;
      border-radius: 18px;
    }
    /**
     * Switch开关样式
     */
    input[type='checkbox'].switch {
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
      width: 40px;
      height: 20px;
      background: black;
      border-radius: 10px;
      transition: border-color .3s, background-color .3s;
    }
    input[type='checkbox'].switch::after {
      content: '';
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0, 0, 2px, #999;
      transition: .4s;
      top: 2px;
      position: absolute;
      left: 2px;
    }
    input[type='checkbox'].switch:checked {
      background: rgb(19, 206, 102);
    }
    /* 当input[type=checkbox]被选中时：伪元素显示下面样式 位置发生变化 */
    input[type='checkbox'].switch:checked::after {
      content: '';
      position: absolute;
      left: 55%;
      top: 2px;
    }
    .control .right .pad-group {
      margin: 40px 0 0 293px;
      border: 1px solid gray;
      border-radius: 20px;
      width: 290px;
      padding: 16px;
    }
    .control .right .pad-group .pads {
      width: 256px;
      height: 256px;
      /* margin-left: 310px; */
      background-image: url('images/1091.png');
    }
    .control .right .pad-group .pads .arrow {
      /* border: 1px solid red; */
      width: 100px;
      height: 100px;
      position: relative;
    }
    .control .right .pad-group .pads .left {
      top: -22px;
    }
    .control .right .pad-group .pads .right {
      float: right;
      top: -122px;
    }
    .control .right .pad-group .pads .up,
    .control .right .pad-group .pads .down {
      left: 78px;
    }
    .control .right .pad-group .pads .down {
      top: -44px;    }
    .control .right .pad-group .zoom-group img {
      margin-top: -10px;
      width: 64px;
      height: 64px;
    }
    .control .right .pad-group .zoom-group img:last-child {
      /* float: right; */
      position: relative;
      left: 124px;
    }
    .control .right .record-btns {
      margin-top: 58px;
      padding-left: 217px;
    }
    .control .right .record-btns .item-btn {
      float: left;
    }
    .control .right .record-btns .item-btn .btn-icon {
      height: 58px;
    }
    .control .right .record-btns .item-btn .btn-title {
      margin-top: 5px;
      text-align: center;
      font-size: 22px;
    }
    .control .right .record-btns .item-btn:not(:last-child) {
      margin-right: 30px;
    }
  </style>
</head>

<body class="whole_body">
<!-- 内容 -->
<div class="app container-fluid">
    <!-- 顶部 -->
    <div class="row top">
      <div class="col-md-3 title">数字化手术室</div>
      <div class="col-md-6 text-center">
        <div id="timeNow" class="time">2020年4月28日12时12分&nbsp;&nbsp;星期三</div>
      </div>
      <div class="col-md-3">
        <img class="logo" src="images/logo.png" />
      </div>
    </div>

    <!-- 摄像头列表 -->
    <div class="row camera">
        <!-- <foreach name="$data['channel']" item="k" key="i">
            <div channel_id='{$k.channel_id}' channel_name="{$k.channel_name}" rtsp="{$k.rtsp_sub}" onclick="selectItem(this)" class="col-md-1 item" >
                <div class="title">{$k.channel_name}</div>
                <div class="icon"><img src="images/10{$i+1}.png" /></div>
                <div class="check">
                    <div class="checkbox-custom checkbox_default">
                        <input enc_id="{$data.id}" addr="{$k.rtsp_main}" ch_no="{$k.channel_id}" type="checkbox">
                        <label></label>
                    </div>
                </div>
            </div>
        </foreach> -->
        <!--
        <div class="col-md-1 item" >
          <div class="title">1号手术室全景相机</div>
          <div class="icon"><img src="images/101.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室术野相机</div>
          <div class="icon"><img src="images/102.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室腔镜</div>
          <div class="icon"><img src="images/103.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室X光</div>
          <div class="icon"><img src="images/104.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室血管造影</div>
          <div class="icon"><img src="images/105.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室血管造影</div>
          <div class="icon"><img src="images/106.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室体征</div>
          <div class="icon"><img src="images/107.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        <div class="col-md-1 item">
          <div class="title">1号手术室工作站</div>
          <div class="icon"><img src="images/108.png" /></div>
          <div class="check">
            <div class="checkbox-custom checkbox_default">
              <input type="checkbox">
              <label></label>
            </div>
          </div>
        </div>
        -->
    </div>

    <div class="row control">
        <div id="videoView" class="col-md-7 left"></div>
        <div class="col-md-5 right">
            <div class="pad-group">
                <div class="pads">
                    <div title="up" class="arrow up"></div>
                    <div title="left" class="arrow left"></div>
                    <div title="right" class="arrow right"></div>
                    <div title="down" class="arrow down"></div>
                </div>
                <div class="zoom-group">
                    <img title="zoom-in" src="images/1092.png" />
                    <img title="zoom-out" src="images/1093.png" />
                </div>
            </div>
            <div class="row record-btns">
                <div title="record" class="item-btn">
                    <img class="btn-icon" src="images/110.png" />
                    <div class="btn-title">开始录像</div>
                </div>
                <div title="capture" class="item-btn">
                    <img class="btn-icon" src="images/112.png" />
                    <div class="btn-title">截图</div>
                </div>
                <div title="view" class="item-btn">
                    <img class="btn-icon" src="images/113.png" />
                    <div class="btn-title">查看截图</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部菜单 -->
    <div class="row menu">
      <div class="col-md-1 item" onclick="goMain()">手术录像</div>
      <div class="col-md-1 item" onclick="goScreen()">影像路由</div>
      <div class="col-md-1 item" onclick="goMedia()">视频点播</div>
      <div class="col-md-1 item" onclick="goTeach()">直播示教</div>
      <div class="col-md-1 item" onclick="goPatient()">电子病历</div>
      <div class="col-md-1 item" onclick="goBedlight()">无影灯控制</div>
      <div class="col-md-1 item" onclick="goBed()">手术床控制</div>
      <div class="col-md-1 item" onclick="goLight()">灯光控制</div>
    </div>
</div>
</body>
<script type="text/javascript">
  let recordId = "{$subj_id}";
  let currentChannel = null;
  let snapTimes = 0;
  
  let currentRoom = null;
  $(document).ready(function() {
    // 标识当前菜单为激活状态
    $('.menu .item:first').addClass("active");
    try {
      // 获取当前房间信息
      currentRoom = JSON.parse(AOV.getCurrentRoom());
      let deviceId = currentRoom.encoder.id;
      console.log("encoder device id: " + deviceId);
      // 获取通道信息
      $.getJSON("/api/dors/channel/device?type=vi&deviceId="+deviceId, function(data) {
        $.each(data.data, function(i, field){
          $(".camera").append(
            '<div class="col-md-1 item" >' +
            '  <div class="title">'+field.name+'</div>' +
            '    <div class="icon"><img src="images/10'+(i+1)+'.png" /></div>' +
            '    <div class="check">' +
            '      <div class="checkbox-custom checkbox_default">' +
            '      <input type="checkbox">' +
            '      <label></label>' +
            '    </div>' +
            '  </div>' +
            '</div>'
          );
        });
      });
      // 校正播放窗口的位置
      changeVideoViewpostion();
    } catch (e) { console.error(e); }
    // 监控方向按钮点击事件
    $('.pads>.arrow').click(function () {
      let arrowTitle = $(this).attr('title');
      if ('up' === arrowTitle) { // 上
        try { // 调用安卓发送串口指令 上
          window.AOV.up();
          autoStopControl(arrowTitle);
        } catch (e) { console.error(e); }
      } else if ('left' === arrowTitle) { // 左
        try { // 调用安卓发送串口指令 左
          window.AOV.left();
          autoStopControl(arrowTitle);
        } catch (e) { console.error(e); }
      } else if ('right' === arrowTitle) { // 右
        try { // 调用安卓发送串口指令 右
          window.AOV.right();
          autoStopControl(arrowTitle);
        } catch (e) { console.error(e); }
      } else if ('down' === arrowTitle) { // 下
        try { // 调用安卓发送串口指令 下
          window.AOV.down();
          autoStopControl(arrowTitle);
        } catch (e) { console.error(e); }
      }
    });
    // 监控放大缩小按钮点击事件
    $('.zoom-group>img').click(function() {
      let btnTitle = $(this).attr('title');
      if ('zoom-in' === btnTitle) { // 放大
        try { // 调用安卓发送串口指令 缩小
          window.AOV.zoomAdd();
          autoStopControl(btnTitle);
        } catch (e) { console.error(e); }
      } else if ('zoom-out' === btnTitle) { // 缩小
        try { // 调用安卓发送串口指令 缩小
          window.AOV.zoomDesc();
          autoStopControl(btnTitle);
        } catch(e) { console.error(e); }
      }
    });
    // 监控录制按钮点击事件
    $('.record-btns>.item-btn').click(function () {
      let _this = $(this);
      let recordBtnTitle = $(this).attr('title');
      if ('record' === recordBtnTitle) { // 录像按钮
        let checkboxList = $(".camera .item .check :checkbox");
        let checkedList = [];
        checkboxList.each((i, element) => {
          let _this_check_box = $(element);
          if(_this_check_box.is(":checked")) {
            checkedList.push({
              "enc_id": _this_check_box.attr("enc_id"),
              "room_name": parseInt(GetQueryString('category_id')),
              "surgery_name": "手术录像",
              "doctor": "",
              "patient": "",
              "addr": _this_check_box.attr("addr"),
              "ch_name": parseInt(_this_check_box.attr("ch_no"))
            });
          }
        });
        console.log(checkedList);
        if(1 > checkedList.length) {
          layer.alert("请选择需要录制的通道");
          return;
        }
        isRecord = !isRecord;
        // 修改按钮图标显示与显示文本
        if(isRecord) { // 录制中
          var obj = {
            list: checkedList
          }
          $.post("{:url('/admin/api/start_work')}", obj, function (data) {
            var json = JSON.parse(data)
            if (parseInt(json.result) == 0) {
              recordId = json.subid;
              $("#btn1").attr("disabled", true);
              isRecord = true;
              _this.children('.btn-icon').attr('src', 'images/111.png');
              _this.children('.btn-title').text('停止录像');
            } else {
              isRecord = false;
              layer.alert("开启录像失败！");
            }
          })
        } else { // 停止录制
          if (recordId != "" && recordId != null) {
            var obj = {
              subj_id: recordId,
            }
            // console.log(sub)
            $.post("{:url('/admin/api/stop_work')}", obj, function (data) {
              console.log(data)
              _this.children('.btn-icon').attr('src', 'images/110.png');
              _this.children('.btn-title').text('开始录像');
            })
          } else {
            layer.alert("没有正在录制的项目");
          }
        }
      } else if ('capture' === recordBtnTitle) { // 截图按钮
        try { // 调用截图
          captureImage()
        } catch (e) { console.error(e); }
      } else if ('view' === recordBtnTitle) { // 查看截图
        goFileManage();
      }
    });
  });
  function selectItem(el) {
    let _this = $(el);
    if(_this.hasClass('active')) { // 当前元素重复选中
      return;
    }
    if (isRecord == true) {
      return
    }
    _this.addClass("active");
    _this.siblings().each((i, element) => {
      $(element).removeClass("active");
    });
    // 串口切换
    gradeChange(_this.attr("channel_name"));
    try {
      // 视频播放
      beforUrl = _this.attr("rtsp");
      window.AOV.changeVideo(beforUrl);
    } catch (e) { console.error(e); }
    currentChannel = _this.attr("channel_id");
  }
  //切换串口
  function gradeChange(x) {
    // console.log("点击 切换串口："+x);
    try {
      window.AOV.changeToSerial(x);
    } catch (e) { console.error(e); }
  }
  /**
   * 从显示器上截图
   */
  function captureImage() {
    //如果没有播放则提示没有课截图的对象
    if (beforUrl != "") {
      switch (parseInt(GetQueryString("protocol"))) {
        case 0:
          //灵派截图
          linkPiSnap();
          break;
      }
    } else {
      layer.msg("暂无正在播放的视频源！")
    }
  }
  /**
   * 灵派编码器截图
   */
  function linkPiSnap() {
    snapTimes = 2;
    snapImage()
  }
  function snapImage() {
    //循环截图4次
    let obj = {
      ip: GetQueryString('ip')
    }

    $.ajax({
      type: "POST",
      url: "{:url('/admin/api/snapImage')}",
      contentType: "application/json", //必须这样写
      dataType: "json",
      data: JSON.stringify(obj),//schoolList是你要提交是json字符串
      success: function (data) {
        if (parseInt(data.result) == 0) {
          // console.log(snapTimes);
          snapTimes--;
          if (snapTimes > 0) {
            snapImage();
          } else {
            downLoadPictureToLocal();
          }
        } else {
          snapTimes++;
          snapImage();
        }
      }
    })
  }
  // 保存截图到本地
  function downLoadPictureToLocal() {
    var src = "http://" + GetQueryString("ip") + "/snap/snap" + currentChannel.toString() + ".jpg?" + "rnd=" + Math.random()
    try {
      window.AOV.savePicToLocal(src)
    } catch (e) { console.error(e); }
  }
  // 延时自动停止控制
  let currentControlObj = null;
  let currentControlObjTimeout = null;
  function autoStopControl(obj) {
    if(obj === currentControlObj) { // 如果当前控制对象没有发生改变, 则先清除该对象的定时器, 再重设定时器.
      clearTimeout(currentControlObjTimeout);
    } else { // 当前控制对象不是之前的, 则不清空原定时器. 修改当前控制对象赋值.
      currentControlObj = obj;
    }
    currentControlObjTimeout = setTimeout(function () {
      window.AOV.stop();
    }, 400);
  }
  /**
   * 跳转安卓本地文件管理
   */
  function goFileManage() {
    try {
      window.AOV.goFileManage();
    } catch(e) { console.error(e); }
  }
</script>
</html>